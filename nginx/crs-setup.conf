# OWASP ModSecurity Core Rule Set Configuration
# This file contains the configuration for the OWASP CRS

# Paranoia Level (1-4, higher = more strict)
SecAction \
    "id:900000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.paranoia_level=1"

# Execution Mode
SecAction \
    "id:900001,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.executing_paranoia_level=1"

# Anomaly Scoring Threshold
SecAction \
    "id:900110,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.inbound_anomaly_score_threshold=5,\
    setvar:tx.outbound_anomaly_score_threshold=4"

# Application specific exclusions
# Exclude authentication endpoints from certain rules
SecRule REQUEST_URI "@beginsWith /auth/" \
    "id:900200,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920272;ARGS,\
    ctl:ruleRemoveTargetById=920273;ARGS"

# Exclude webhook endpoints from body inspection for large payloads
SecRule REQUEST_URI "@beginsWith /api/webhooks/" \
    "id:900201,\
    phase:1,\
    pass,\
    nolog,\
    ctl:requestBodyProcessor=JSON"

# Exclude static assets from processing
SecRule REQUEST_URI "@beginsWith /static/" \
    "id:900202,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Exclude health check endpoint
SecRule REQUEST_URI "@streq /health" \
    "id:900203,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Allow WebAwesome components and fonts
SecRule REQUEST_URI "@beginsWith /webawesome/" \
    "id:900204,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /fonts/" \
    "id:900205,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Geographic blocking (optional - uncomment to enable)
# Block known bad countries (adjust as needed)
# SecRule REMOTE_ADDR "@geoLookup" \
#     "id:900300,\
#     phase:1,\
#     block,\
#     msg:'Blocked country',\
#     logdata:'Country: %{geo.country_code}',\
#     chain"
# SecRule GEO:COUNTRY_CODE "@pmFromFile /etc/nginx/blocked-countries.txt"

# Sampling percentage (0-100)
SecAction \
    "id:900400,\
    phase:1,\
    nolog,\
    pass,\
    setvar:tx.sampling_percentage=100"

# HTTP policy settings
SecAction \
    "id:900500,\
    phase:1,\
    nolog,\
    pass,\
    setvar:tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE,\
    setvar:tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |application/json| |text/plain|,\
    setvar:tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0,\
    setvar:tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/,\
    setvar:tx.restricted_headers=/proxy-connection/ /lock-token/ /content-range/ /translate/ /if/"

# CRS initialization
SecAction \
    "id:900990,\
    phase:1,\
    nolog,\
    pass,\
    t:none"