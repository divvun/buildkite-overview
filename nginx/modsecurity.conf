# ModSecurity Configuration File

# Include base ModSecurity configuration
Include /etc/modsecurity/modsecurity.conf

# Include OWASP CRS setup
Include /etc/nginx/crs-setup.conf

# Include OWASP Core Rule Set
Include /opt/owasp-modsecurity-crs/rules/*.conf

# Include custom rules
Include /etc/nginx/custom-rules.conf

# ModSecurity engine configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off

# Request body limits
SecRequestBodyLimit 1048576          # 1MB
SecRequestBodyNoFilesLimit 131072    # 128KB

# Debug logging (disable in production)
SecDebugLog /var/log/modsecurity/modsec_debug.log
SecDebugLogLevel 1

# Audit logging
SecAuditEngine On
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABDEFHIJKZ
SecAuditLogType Concurrent
SecAuditLogStorageDir /var/log/modsecurity/
SecAuditLog /var/log/modsecurity/modsec_audit.log

# Response body processing
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimitAction ProcessPartial

# Geo IP database (optional)
# SecGeoLookupDb /usr/share/GeoIP/GeoIP.dat

# Action for blocked requests
SecDefaultAction "phase:1,log,auditlog,deny,status:403"

# Custom error page (optional)
# SecErrorDocument @error-page